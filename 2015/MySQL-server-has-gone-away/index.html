<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> MySQL server has gone away错误查找 · soki</title><meta name="description" content="MySQL server has gone away错误查找 - soki"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">文章</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">订阅</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">MySQL server has gone away错误查找</h1><div class="post-time">Apr 9, 2015</div><div class="post-content"><p>在测试服务器上发现一个php守护进程异常退出，查看日志发现报了<code>Warning: PDO::prepare(): MySQL server has gone away</code> 的错误</p>
<p>一番查找发现有几种情况会出现这个错误。<br>1、MySQL服务器宕机<br>2、连接长时间没有操作，MySQL发现连接超过wait_timeout所配置的时间，MySQL就会关闭这个连接<br>可以通过命令 <code>SHOW GLOBAL VARIABLES LIKE &quot;%timeout&quot;</code> 查看 wait_timeout参数<br>3、当查询的结果集超过了max_allowed_packet设置的大小</p>
<p>MySQL服务正常第一条可以排除<br>max_allowed_packet 配置是16M，查询的数据肯定不会超过这个大小也可以排除</p>
<p><strong>发现问题</strong><br>php使用的是PDO操作数据库，php在脚本结束时会自动关闭连接，应该不会有超时的问题<br>出问题的正好是守护进程，通过查看代码，发现代码里有缓存PDO对象，php又是以守护进程的方式运行，连接MySQL之后并不会去关闭连接，在没有操作时连接会一直处在睡眠状态。<br>当守护进程启动后，通过 <code>SHOW PROCESSLIST</code> 可以看到状态为Sleep<br><a id="more"></a></p>
<p>测试服在晚上时基本没有操作，这样超过28800秒之后MySQL关闭了这个连接，当php再次处理数据时就报出了上面的错误。</p>
<p><strong>解决问题</strong><br>my.conf文件修改参数<br>wait_timeout=86400</p>
<p>相关问题<br><a href="http://stackoverflow.com/questions/7942154/mysql-error-2006-mysql-server-has-gone-away" target="_blank" rel="external">http://stackoverflow.com/questions/7942154/mysql-error-2006-mysql-server-has-gone-away</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/transfer-closed-with-outstanding-read-data-remaining/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 <a href="http://haov.net">soki</a>, unless otherwise noted.</p></div></footer></div><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>