<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> transfer-closed-with-outstanding-read-data-remaining · soki</title><meta name="description" content="transfer-closed-with-outstanding-read-data-remaining - soki"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">文章</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">订阅</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">transfer-closed-with-outstanding-read-data-remaining</h1><div class="post-time">Feb 13, 2015</div><div class="post-content"><p>最近有个别用户反映一直进不去游戏，卡在登录画面。经过排查发现客户端调用某接口的时候数据获取不全，通过抓包发现只要获取到一定数据量时，客户端就主动把连接关闭。客户端使用libcurl，所以我在命令行里也用curl模拟了一次请求，发现也是在获取到一定的数据后就出现 <code>transfer closed with outstanding read data remaining</code> 的错误，而且还是必现。</p>
<p>经过一翻google发现了一些可能引起错误的原因</p>
<p><strong>Expect: 100-continue</strong></p>
<blockquote>
<p>当客户端要post较大的数据时，客户端会先发送一个包含 Expect: 100-continue 的头信息，询问服务器是否接受请求，如果接受，服务器返回100-continue，客户端再post数据。<br><a id="more"></a><br>我们post的数据才几十字节而已，这个问题基本可以忽略。</p>
</blockquote>
<p>继续排查</p>
<p>经过调试发现在浏览器上请求接口正常，而curl请求始终失败出错。经过对比头信息，发现浏览器上多了 <code>Content-Encoding:gzip</code> 头，<code>curl</code> 启用 <code>-compressed</code> 参数后也正常了。</p>
<p>客户端查看代码确实也没有启用<code>gzip</code>，加上<code>gzip</code>，更新版本，问题玩家登录一切正常，问题解决。</p>
<p>压缩也只是把数据变小，上面说到的接口只有个别的用户会出现问题，对比正常玩家和出问题的玩家，发现返回的数据大小在一个分界线，到达一定数据大小时必现。可以肯定是跟<code>php</code> <code>nginx</code>大数据包有关系。</p>
<p>在我们内网的测试环境，进入游戏时会调用一个数据非常大的接口，外网不会调用，按这种情况内网必定会出现错误才对。但是内网却没有问题。未完待续。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/MySQL-server-has-gone-away/" class="prev">PREV</a><a href="/2014/浮点数二进制表示/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 <a href="http://haov.net">soki</a>, unless otherwise noted.</p></div></footer></div><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>